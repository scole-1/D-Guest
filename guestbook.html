<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8" />
<title>Digital Guestbook</title>
<meta name="viewport" content="width=device-width, initial-scale=1.0" />
<style>
body {
  font-family: system-ui, sans-serif;
  background: #111827;
  color: #f9fafb;
  margin: 0;
  display: flex;
  justify-content: center;
  align-items: center;
  min-height: 100vh;
}
.container {
  width: 100%;
  max-width: 420px;
  padding: 20px;
}
.card {
  background: #020617;
  border-radius: 16px;
  padding: 20px;
}
button {
  width: 100%;
  padding: 14px;
  margin-top: 10px;
  border-radius: 999px;
  border: none;
  font-size: 16px;
}
.primary {
  background: #22c55e;
  color: #022c22;
}
.secondary {
  background: transparent;
  border: 1px solid #4b5563;
  color: #e5e7eb;
}
input {
  width: 100%;
  padding: 10px;
  margin-top: 6px;
  border-radius: 999px;
  border: 1px solid #4b5563;
  background: #020617;
  color: white;
}
.screen { display: none; }
.screen.active { display: block; }
.list-item {
  padding: 10px;
  border: 1px solid #4b5563;
  border-radius: 999px;
  margin-top: 6px;
  cursor: pointer;
}
img {
  max-width: 100%;
  border-radius: 12px;
  margin-top: 10px;
}
</style>
</head>

<body>
<div class="container">

<div id="main" class="screen active card">
  <h2>Digital Guestbook</h2>
  <button class="primary" onclick="show('photo')">Sign with Photo</button>
  <button class="secondary" onclick="show('search')">Search Name</button>
</div>

<div id="photo" class="screen card">
  <input type="file" accept="image/*" onchange="onPhoto(event)">
  <img id="preview" />
  <input id="photoName" placeholder="Your name">
  <button class="primary" onclick="submitPhoto()">Submit</button>
  <button class="secondary" onclick="back()">Back</button>
</div>

<div id="search" class="screen card">
  <input id="searchInput" placeholder="Type your name" oninput="searchGuest()">
  <div id="results"></div>
  <button class="secondary" onclick="back()">Back</button>
</div>

<div id="thanks" class="screen card">
  <h2>Thank you ❤️</h2>
  <button class="primary" onclick="back()">Done</button>
</div>

</div>

<script>
function show(id) {
  document.querySelectorAll(".screen").forEach(s => s.classList.remove("active"));
  document.getElementById(id).classList.add("active");
}

function back() {
  location.reload();
}

let photoData = null;

function onPhoto(e) {
  const file = e.target.files[0];
  const reader = new FileReader();
  reader.onload = () => {
    photoData = reader.result;
    document.getElementById("preview").src = photoData;
  };
  reader.readAsDataURL(file);
}

async function submitPhoto() {
  const name = document.getElementById("photoName").value.trim();
  if (!name || !photoData) {
    alert("Missing name or photo");
    return;
  }

  await fetch("/.netlify/functions/sign-with-photo", {
    method: "POST",
    headers: { "Content-Type": "application/json" },
    body: JSON.stringify({ name, photo: photoData })
  });

  show("thanks");
}

let timer;
function searchGuest() {
  clearTimeout(timer);
  timer = setTimeout(async () => {
    const q = document.getElementById("searchInput").value;
    if (!q) return;

    const res = await fetch("/.netlify/functions/search-guest?query=" + q);
    const data = await res.json();

    const box = document.getElementById("results");
    box.innerHTML = "";

    data.forEach(g => {
      const div = document.createElement("div");
      div.className = "list-item";
      div.textContent = g.name + (g.signed ? " ✓" : "");
      div.onclick = () => markSigned(g.id);
      box.appendChild(div);
    });
  }, 300);
}

async function markSigned(id) {
  await fetch("/.netlify/functions/mark-signed", {
    method: "POST",
    headers: { "Content-Type": "application/json" },
    body: JSON.stringify({ id })
  });
  show("thanks");
}
</script>
</body>
</html>
